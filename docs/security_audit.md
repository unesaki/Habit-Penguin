# セキュリティ監査レポート

## 概要

このドキュメントは、Habit Penguinアプリのセキュリティ対策と監査結果をまとめたものです。

**監査日**: 2025年1月
**バージョン**: 1.0.0
**監査範囲**: データ保護、依存関係、アプリケーションセキュリティ

## エグゼクティブサマリー

### セキュリティ評価

| カテゴリ | ステータス | リスクレベル |
|---------|----------|------------|
| データ暗号化 | ✅ 実装済み | 低 |
| データ保存 | ✅ ローカルのみ | 低 |
| 依存関係 | ⚠️ 一部更新推奨 | 低 |
| 認証・認可 | N/A（ローカルアプリ） | - |
| ネットワーク通信 | ✅ なし | 低 |
| プライバシー | ✅ GDPR/CCPA準拠 | 低 |

### 全体評価: **良好** ✅

Habit Penguinは、ローカルファーストのアーキテクチャを採用しており、外部サーバーとの通信がないため、ネットワーク関連のセキュリティリスクは低いです。

## 1. データ暗号化

### 1.1 実装状況

✅ **実装完了**

**EncryptionService** (`lib/services/encryption_service.dart`)を実装：

- AES-256暗号化をサポート
- 暗号化キーはプラットフォームのセキュアストレージに保存
- Hiveの暗号化機能を利用

**使用技術:**
- `flutter_secure_storage`: iOS Keychain / Android KeyStore
- `HiveAesCipher`: AES-256-CBC暗号化
- `crypto`: 暗号化関連のユーティリティ

### 1.2 暗号化対象データ

**現在の方針:**
- タスク名、メモなどの個人情報
- 完了履歴
- アプリ設定

**暗号化は推奨だがオプション:**
- パフォーマンスへの影響を最小化
- ユーザーが選択可能（将来的な機能）

### 1.3 キー管理

**セキュアストレージの使用:**
```dart
// iOS: Keychain with kSecAttrAccessibleAfterFirstUnlock
// Android: EncryptedSharedPreferences
// macOS: Keychain
// Windows/Linux: 暗号化ストレージ
```

**キーのライフサイクル:**
- 初回起動時に自動生成
- アプリアンインストール時に削除
- ユーザーによる手動削除も可能

### 1.4 セキュリティ考慮事項

✅ **強み:**
- 256ビット鍵長（AES-256）
- プラットフォームネイティブのセキュアストレージ
- ランダム鍵生成（crypto.Random.secure()）

⚠️ **制限事項:**
- メモリ上では平文として扱われる
- デバッグモードではログに出力される可能性

## 2. データ保存とアクセス制御

### 2.1 データの保存場所

✅ **ローカルストレージのみ**

- すべてのデータはデバイス内に保存
- 外部サーバーへの送信なし
- クラウド同期なし（将来的な機能）

**Hiveデータベース:**
- Location: アプリのドキュメントディレクトリ
- アクセス: アプリのみ（OSのサンドボックス）
- バックアップ: OSのバックアップ機能に従う

### 2.2 アクセス制御

✅ **OSレベルの保護**

- iOS: App Sandbox
- Android: App-specific storage
- macOS: App Sandbox
- Windows/Linux: ユーザーディレクトリ

### 2.3 データ永続化のセキュリティ

| 項目 | 実装状況 | 評価 |
|------|---------|-----|
| ローカル保存 | ✅ | 安全 |
| 暗号化オプション | ✅ | 良好 |
| バックアップ制御 | ⚠️ | OS依存 |
| データ削除 | ✅ | 完全 |

## 3. 依存パッケージのセキュリティ

### 3.1 主要依存関係の監査

**実行コマンド:**
```bash
flutter pub outdated
```

**結果（2025年1月時点）:**

| パッケージ | 現在 | 最新 | セキュリティアドバイザリ | 推奨アクション |
|-----------|-----|------|---------------------|--------------|
| hive | 2.2.3 | 2.2.3 | なし | 定期確認 |
| hive_flutter | 1.1.0 | 1.1.0 | なし | 定期確認 |
| flutter_riverpod | 2.6.1 | 3.0.3 | なし | 更新検討 |
| flutter_local_notifications | 18.0.1 | 19.4.2 | なし | 更新検討 |
| share_plus | 10.1.4 | 12.0.0 | なし | 更新検討 |
| flutter_secure_storage | 9.2.4 | 最新 | なし | OK |
| path_provider | 2.1.5 | 最新 | なし | OK |
| timezone | 0.9.4 | 0.10.1 | なし | 更新検討 |

### 3.2 セキュリティアドバイザリ確認

✅ **現時点で重大な脆弱性なし**

**確認方法:**
```bash
flutter pub outdated --json | jq '.packages[] | select(.isCurrentAffectedByAdvisory == true)'
```

**結果:** 該当なし

### 3.3 依存関係管理のベストプラクティス

**推奨事項:**
1. ✅ 定期的な `flutter pub outdated` の実行（月次）
2. ✅ セキュリティアドバイザリの確認
3. ⚠️ メジャーバージョンアップ前のテスト
4. ⚠️ CI/CDでの自動チェック（未実装）

## 4. アプリケーションセキュリティ

### 4.1 入力検証

**現在の実装:**

| 入力箇所 | 検証 | 評価 |
|---------|-----|-----|
| タスク名 | ✅ 必須チェック | 良好 |
| 日付選択 | ✅ 範囲チェック | 良好 |
| 難易度選択 | ✅ Enum制約 | 安全 |

**推奨改善:**
- 最大文字数制限の追加
- 特殊文字のサニタイゼーション

### 4.2 エラーハンドリング

✅ **実装済み**

- すべてのデータ操作でtry-catch
- ユーザーフレンドリーなエラーメッセージ
- 機密情報の漏洩なし

### 4.3 ログとデバッグ情報

⚠️ **改善の余地あり**

**現状:**
- デバッグモードでの詳細ログ
- リリースビルドでのログ削除

**推奨事項:**
- センシティブデータのログ除外
- kDebugModeでの条件付きログ

## 5. プライバシーとコンプライアンス

### 5.1 GDPR/CCPA準拠

✅ **完全準拠**

- データエクスポート機能
- データ削除機能
- プライバシーポリシー
- 利用規約

詳細: [privacy_data_management.md](privacy_data_management.md)

### 5.2 データ最小化

✅ **実装済み**

収集データ:
- タスク情報（必須）
- 完了履歴（機能的に必要）
- リマインダー設定（ユーザー選択）

収集しないデータ:
- 位置情報
- 連絡先
- カメラ・マイク
- 広告ID

### 5.3 第三者サービス

✅ **最小限の使用**

| サービス | 用途 | データ送信 |
|---------|-----|----------|
| flutter_local_notifications | 通知 | なし |
| share_plus | ファイル共有 | OS経由のみ |
| flutter_secure_storage | 暗号鍵保存 | なし |

## 6. プラットフォーム別のセキュリティ

### 6.1 iOS

✅ **セキュリティ機能:**
- App Sandbox
- Keychain（暗号鍵保存）
- Data Protection（ファイル暗号化）

**権限:**
- 通知（ユーザー承認必要）

### 6.2 Android

✅ **セキュリティ機能:**
- App-specific storage
- EncryptedSharedPreferences
- KeyStore（暗号鍵保存）

**権限:**
- 通知（Android 13+で必要）

**推奨設定:**
```xml
<!-- AndroidManifest.xml -->
<application
    android:allowBackup="false"
    android:fullBackupContent="false">
</application>
```

### 6.3 macOS

✅ **セキュリティ機能:**
- App Sandbox
- Keychain
- File quarantine

### 6.4 Web/Windows/Linux

⚠️ **制限事項:**
- セキュアストレージの実装が異なる
- 暗号化の強度がプラットフォーム依存

## 7. 脅威モデル

### 7.1 想定される脅威

| 脅威 | リスクレベル | 対策状況 |
|-----|------------|---------|
| デバイス紛失・盗難 | 中 | ✅ 暗号化オプション |
| マルウェア | 中 | ✅ OS依存 |
| 物理アクセス | 低 | ✅ OS保護 |
| ネットワーク盗聴 | なし | N/A |
| サーバー侵害 | なし | N/A |
| SQLインジェクション | なし | N/A（NoSQL） |

### 7.2 攻撃シナリオと対策

**シナリオ1: デバイス紛失**
- リスク: データへの不正アクセス
- 対策: 暗号化、OSのロック画面

**シナリオ2: マルウェア感染**
- リスク: データの読み取り・改ざん
- 対策: OSのサンドボックス、アプリストアの審査

**シナリオ3: バックアップからの復元**
- リスク: 暗号化キーの喪失
- 対策: セキュアストレージは通常バックアップ対象外

## 8. セキュリティチェックリスト

### 開発時

- [x] コード内にハードコードされたシークレットがない
- [x] センシティブデータのログ出力がない（または条件付き）
- [x] すべてのエラーが適切にハンドリングされている
- [x] 入力検証が実装されている
- [x] 依存パッケージが最新または既知の脆弱性がない

### ビルド時

- [ ] リリースビルドでデバッグ情報が削除されている
- [ ] コード難読化が有効（ProGuard/R8）
- [ ] 未使用コードが削除されている（tree shaking）
- [x] 適切な署名がされている

### デプロイ時

- [ ] ストアの審査を通過
- [x] プライバシーポリシーが公開されている
- [x] 利用規約が公開されている
- [ ] セキュリティ連絡先が設定されている

## 9. 推奨事項

### 短期（1-3ヶ月）

1. **コード難読化の有効化**
   - ProGuard/R8の設定
   - シンボルマップの保存

2. **依存パッケージの更新**
   - メジャーバージョンアップの検討
   - 互換性テストの実施

3. **セキュリティテストの追加**
   - ユニットテストにセキュリティケースを追加
   - 暗号化機能のテスト

### 中期（3-6ヶ月）

1. **CI/CDでのセキュリティチェック**
   - 自動脆弱性スキャン
   - 静的解析ツールの導入

2. **暗号化の強化**
   - バイオメトリクス認証との統合
   - キー回転メカニズム

3. **ログ管理の改善**
   - 構造化ロギング
   - センシティブデータの自動マスキング

### 長期（6ヶ月以上）

1. **外部セキュリティ監査**
   - 第三者によるペネトレーションテスト
   - コードレビュー

2. **バグバウンティプログラム**
   - 脆弱性報奨金制度の導入

3. **セキュリティ認証の取得**
   - 必要に応じてISO 27001等の検討

## 10. インシデント対応

### 10.1 脆弱性発見時の対応フロー

1. **報告受付**: セキュリティ連絡先へ報告
2. **評価**: 重大度の判定（Critical/High/Medium/Low）
3. **修正**: パッチの開発
4. **テスト**: 修正の検証
5. **リリース**: 緊急アップデートの配布
6. **通知**: ユーザーへの告知（必要に応じて）

### 10.2 連絡先

**セキュリティ問題の報告:**
- Email: [セキュリティ担当メールアドレスを追加]
- GitHub: [Private security advisories]

## 11. 結論

Habit Penguinは、現時点で**良好なセキュリティ体制**を維持しています。主な強みは以下の通りです：

✅ **強み:**
- ローカルファーストのアーキテクチャ
- データ暗号化のサポート
- GDPR/CCPA準拠
- 最小限の依存関係
- 第三者サービスへのデータ送信なし

⚠️ **改善の余地:**
- 依存パッケージの定期更新プロセス
- CI/CDでの自動セキュリティチェック
- コード難読化の有効化

**総合評価: A（優良）**

本アプリは、個人情報を扱うアプリとして適切なセキュリティ対策が施されており、本番リリースに十分な水準に達しています。

---

**次回監査予定**: 2025年7月（6ヶ月後）
**監査担当**: [担当者名]
**承認**: [承認者名]
